<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PhaseEstimation.vqe &mdash; PhaseEstimationThroughQML 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> PhaseEstimationThroughQML
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PhaseEstimationThroughQML</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>PhaseEstimation.vqe</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for PhaseEstimation.vqe</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; This module implements the base function to implement a VQE. &quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">pennylane</span> <span class="k">as</span> <span class="nn">qml</span>
<span class="kn">from</span> <span class="nn">pennylane</span> <span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax.example_libraries</span> <span class="kn">import</span> <span class="n">optimizers</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">pickle</span>  <span class="c1"># Writing and loading</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;For Hamiltonians, the eigenvalues will be computed numerically. This may be computationally intensive for a large number of wires.Consider using a sparse representation of the Hamiltonian with qml.SparseHamiltonian.&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">PhaseEstimation</span> <span class="kn">import</span> <span class="n">circuits</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">hamiltonians</span>
<span class="kn">from</span> <span class="nn">PhaseEstimation</span> <span class="kn">import</span> <span class="n">general</span> <span class="k">as</span> <span class="n">qmlgen</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>

<span class="c1">##############</span>

<div class="viewcode-block" id="circuit_ising"><a class="viewcode-back" href="../../PhaseEstimation.html#PhaseEstimation.vqe.circuit_ising">[docs]</a><span class="k">def</span> <span class="nf">circuit_ising</span><span class="p">(</span><span class="n">N</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">params</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Number</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Full VQE circuit</span>
<span class="sd">    Number of parameters (gates): 7*N</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N : int</span>
<span class="sd">        Number of qubits</span>
<span class="sd">    params: np.ndarray</span>
<span class="sd">        Array of parameters/rotation for the circuit</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Total number of parameters needed to build this circuit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># No wire will be measured until the end, the array of active</span>
    <span class="c1"># wire will correspond to np.arange(N) throughout the whole circuit</span>
    <span class="n">active_wires</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">qml</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span> <span class="c1"># Depth of the circuit</span>
        <span class="c1"># Iterate circuit_ID9, the deeper the merrier</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">circuits</span><span class="o">.</span><span class="n">circuit_ID9</span><span class="p">(</span><span class="n">active_wires</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">qml</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>
    
    <span class="c1"># Final independent rotations RX for each wire</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">circuits</span><span class="o">.</span><span class="n">wall_gate</span><span class="p">(</span><span class="n">active_wires</span><span class="p">,</span> <span class="n">qml</span><span class="o">.</span><span class="n">RX</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">index</span></div>

<div class="viewcode-block" id="circuit_ising2"><a class="viewcode-back" href="../../PhaseEstimation.html#PhaseEstimation.vqe.circuit_ising2">[docs]</a><span class="k">def</span> <span class="nf">circuit_ising2</span><span class="p">(</span><span class="n">N</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">params</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Number</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Full VQE circuit, enhanced version of circuit_ising, higher number of parameters</span>
<span class="sd">    Number of parameters (gates): 11*N</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N : int</span>
<span class="sd">        Number of qubits</span>
<span class="sd">    params: np.ndarray</span>
<span class="sd">        Array of parameters/rotation for the circuit</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Total number of parameters needed to build this circuit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># No wire will be measured until the end, the array of active</span>
    <span class="c1"># wire will correspont to np.arange(N) throughout the whole circuit</span>
    <span class="n">active_wires</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">qml</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">circuits</span><span class="o">.</span><span class="n">circuit_ID9</span><span class="p">(</span><span class="n">active_wires</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">qml</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>
        
    <span class="n">index</span> <span class="o">=</span> <span class="n">circuits</span><span class="o">.</span><span class="n">wall_gate</span><span class="p">(</span><span class="n">active_wires</span><span class="p">,</span> <span class="n">qml</span><span class="o">.</span><span class="n">RX</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">circuits</span><span class="o">.</span><span class="n">wall_gate</span><span class="p">(</span><span class="n">active_wires</span><span class="p">,</span> <span class="n">qml</span><span class="o">.</span><span class="n">RY</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">index</span></div>

<div class="viewcode-block" id="vqe"><a class="viewcode-back" href="../../PhaseEstimation.html#PhaseEstimation.vqe.vqe">[docs]</a><span class="k">class</span> <span class="nc">vqe</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Hs</span> <span class="p">:</span> <span class="n">hamiltonians</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="n">circuit</span> <span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class for the VQE algorithm</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Hs : hamiltonians.hamiltonian</span>
<span class="sd">            Custom Hamiltonian class</span>
<span class="sd">        circuit : function</span>
<span class="sd">            Function of the VQE circuit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span> <span class="o">=</span> <span class="n">Hs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">circuit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circuit_fun</span> <span class="o">=</span> <span class="n">circuit</span>
        <span class="c1"># Pass the parameter array [0]*10000 (intentionally large) to the circuit</span>
        <span class="c1"># which it will output `index`, namely the number of parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="c1"># Initialize randomly all the parameter-arrays for each state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">n_states</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_params</span><span class="p">))</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;default.qubit.jax&quot;</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1">### STATES FUNCTIONS ###</span>
        <span class="c1"># QCircuit: CIRCUIT(params) -&gt; PSI</span>
        <span class="nd">@qml</span><span class="o">.</span><span class="n">qnode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s2">&quot;jax&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">q_vqe_state</span><span class="p">(</span><span class="n">vqe_params</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="p">(</span><span class="n">vqe_params</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">qml</span><span class="o">.</span><span class="n">state</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">v_q_vqe_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">q_vqe_state</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># vmap of the state circuit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jv_q_vqe_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_q_vqe_state</span><span class="p">)</span>                     <span class="c1"># jitted vmap of the state circuit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j_q_vqe_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">q_vqe_state</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>                <span class="c1"># jitted state circuit</span>

        <span class="c1"># For updating progress bar on fidelity between true states and vqe states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jv_fidelties</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">true</span><span class="p">,</span> <span class="n">pars</span><span class="p">:</span> <span class="n">losses</span><span class="o">.</span><span class="n">vqe_fidelities</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">q_vqe_state</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1">### ENERGY FUNCTIONS ###</span>
        <span class="c1"># Computes &lt;psi|H|psi&gt;</span>
        <span class="k">def</span> <span class="nf">compute_vqe_E</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">@</span> <span class="n">Hmat</span> <span class="o">@</span> <span class="n">state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">j_compute_vqe_E</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">compute_vqe_E</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_compute_vqe_E</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">compute_vqe_E</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jv_compute_vqe_E</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_compute_vqe_E</span><span class="p">)</span>
        
        <span class="c1"># Loss function: LOSS = 1/n_states SUM_i ( ENERGY(psi_i) )</span>
        <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">Hs</span><span class="p">):</span>
            <span class="n">pred_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_q_vqe_state</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">vqe_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_compute_vqe_E</span><span class="p">(</span><span class="n">pred_states</span><span class="p">,</span> <span class="n">Hs</span><span class="p">)</span>
            
            <span class="c1"># Cast as real because energies are supposed to be it</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">vqe_e</span><span class="p">))</span>

        <span class="c1"># Grad function, used in updating the parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jd_loss</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># QCircuit just for printing it</span>
        <span class="nd">@qml</span><span class="o">.</span><span class="n">qnode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s2">&quot;jax&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">vqe_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># Passing np.arange array for enumerating the parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_params</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">qml</span><span class="o">.</span><span class="n">state</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">qml</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">vqe_state</span><span class="p">)(</span><span class="bp">self</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">Hs_batch</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="n">opt_update</span><span class="p">,</span> <span class="n">get_params</span><span class="p">):</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jd_loss</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">Hs_batch</span><span class="p">)</span>
        <span class="n">opt_state</span> <span class="o">=</span> <span class="n">opt_update</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grads</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">get_params</span><span class="p">(</span><span class="n">opt_state</span><span class="p">),</span> <span class="n">opt_state</span> 

    <span class="k">def</span> <span class="nf">_get_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Number</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for getting the neighbouring indexes</span>
<span class="sd">        (up, down, left, right) of a given state (K, L)</span>
<span class="sd">        in the ANNNI model.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        </span>
<span class="sd">        Indexes:</span>
<span class="sd">        +--------------+</span>
<span class="sd">        | 4  9  14  19 |</span>
<span class="sd">        | 3  8  13  18 |</span>
<span class="sd">        | 2  7  12  17 |</span>
<span class="sd">        | 1  6  11  16 |</span>
<span class="sd">        | 0  5  10  15 |</span>
<span class="sd">        +--------------+</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; get_neighbours(vqeclass, 0)</span>
<span class="sd">        array([1, 5])</span>
<span class="sd">        &gt;&gt;&gt; get_neighbours(vqeclass, 12)</span>
<span class="sd">        array([7, 13, 17, 11])</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vqeclass : class</span>
<span class="sd">            Class of the VQE, used to get the size of the side and the recycle rule</span>
<span class="sd">        idx : int</span>
<span class="sd">            Index of the desired state</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Neighbouring indexes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">side</span>
        
        <span class="n">neighbours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">side</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">side</span><span class="p">])</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">neighbours</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">recycle_rule</span><span class="p">))</span> <span class="p">)</span>


        <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">side</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">n_states</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">neighbours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">neighbours</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">idx</span>    <span class="p">)</span> <span class="o">%</span> <span class="n">side</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">neighbours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">neighbours</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">neighbours</span>
        
<div class="viewcode-block" id="vqe.train_site"><a class="viewcode-back" href="../../PhaseEstimation.html#PhaseEstimation.vqe.vqe.train_site">[docs]</a>    <span class="k">def</span> <span class="nf">train_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lr</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">site</span> <span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Minimize &lt;psi|H|psi&gt; for a single site</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all the necessary training parameters for the VQD algorithm</span>
        <span class="c1"># &gt; H: Hamiltonian of the model</span>
        <span class="c1"># &gt; H_eff: Effective Hamiltonian for the model (H +|psi&gt;&lt;psi|)</span>
        <span class="c1"># &gt; site: index for (L,K) combination</span>
        <span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_e0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">qmlgen</span><span class="o">.</span><span class="n">get_VQE_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">qml_Hs</span><span class="p">[</span><span class="n">site</span><span class="p">])</span>

        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">]</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vqe_params0</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        
        <span class="n">opt_init</span><span class="p">,</span> <span class="n">opt_update</span><span class="p">,</span> <span class="n">get_params</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
        <span class="n">opt_state</span> <span class="o">=</span> <span class="n">opt_init</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">):</span>
            <span class="n">param</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="n">opt_update</span><span class="p">,</span> <span class="n">get_params</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">vqe_e0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jv_compute_vqe_E</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jv_q_vqe_state</span><span class="p">(</span><span class="n">param</span><span class="p">),</span> <span class="n">H</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span></div>
          
<div class="viewcode-block" id="vqe.train_site_excited"><a class="viewcode-back" href="../../PhaseEstimation.html#PhaseEstimation.vqe.vqe.train_site_excited">[docs]</a>    <span class="k">def</span> <span class="nf">train_site_excited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lr</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">site</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">beta</span> <span class="p">:</span> <span class="n">Number</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Minimize &lt;psi|H|psi&gt; + beta|&lt;psi|psi_0&gt;|^2 for a single site</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all the necessary training parameters for the VQD algorithm</span>
        <span class="c1"># &gt; H: Hamiltonian of the model</span>
        <span class="c1"># &gt; H_eff: Effective Hamiltonian for the model (H +|psi&gt;&lt;psi|)</span>
        <span class="c1"># &gt; site: index for (L,K) combination</span>
        <span class="n">H</span><span class="p">,</span> <span class="n">H_eff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_e1</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">qmlgen</span><span class="o">.</span><span class="n">get_VQD_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">qml_Hs</span><span class="p">[</span><span class="n">site</span><span class="p">],</span> <span class="n">beta</span><span class="p">)</span>
        
        <span class="n">param</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vqe_params1</span><span class="p">[[</span><span class="n">site</span><span class="p">]])</span>
        <span class="n">opt_init</span><span class="p">,</span> <span class="n">opt_update</span><span class="p">,</span> <span class="n">get_params</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
        <span class="n">opt_state</span> <span class="o">=</span> <span class="n">opt_init</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">):</span>
            <span class="n">param</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">H_eff</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="n">opt_update</span><span class="p">,</span> <span class="n">get_params</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">vqe_e1</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jv_compute_vqe_E</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jv_q_vqe_state</span><span class="p">(</span><span class="n">param</span><span class="p">),</span> <span class="n">H</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params1</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span></div>

<div class="viewcode-block" id="vqe.train"><a class="viewcode-back" href="../../PhaseEstimation.html#PhaseEstimation.vqe.vqe.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lr</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">circuit</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Training function for the VQE.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lr : float</span>
<span class="sd">            Learning rate to be multiplied in the circuit-gradient output</span>
<span class="sd">        n_epochs : int</span>
<span class="sd">            Total number of epochs for each learning</span>
<span class="sd">        circuit : bool</span>
<span class="sd">            if True -&gt; Prints the circuit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pred_site</span> <span class="p">:</span> <span class="nb">int</span>

        <span class="k">if</span> <span class="n">circuit</span><span class="p">:</span>
            <span class="c1"># Display the circuit</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;+--- CIRCUIT ---+&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="c1"># The true GS energies will be computed during training</span>
        <span class="c1"># and not during initialization of the VQE since it </span>
        <span class="c1"># requires the diagonalization of many large matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vqe_e0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_e0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">n_states</span><span class="p">,)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">n_states</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_params</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">n_states</span><span class="p">,))</span>
        
        <span class="n">progress</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">recycle_rule</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Site will follow the order of Hs.recycle rule:</span>
        <span class="c1"># For ANNI Model:</span>
        <span class="c1">#     INDICES              RECYCLE RULE</span>
        <span class="c1"># +--------------+       +--------------+</span>
        <span class="c1"># | 4  9  14  19 |       | 4  5  14  15 |</span>
        <span class="c1"># | 3  8  13  18 |       | 3  6  13  16 |</span>
        <span class="c1"># | 2  7  12  17 |  ==&gt;  | 2  7  12  17 |</span>
        <span class="c1"># | 1  6  11  16 |       | 1  8  11  18 |</span>
        <span class="c1"># | 0  5  10  15 |       | 0  9  10  19 |</span>
        <span class="c1"># +--------------+       +--------------+</span>
        <span class="c1">#</span>
        <span class="c1"># For Ising Chain:</span>
        <span class="c1">#    INDICES               RECYCLE RULE</span>
        <span class="c1"># +------------ -        +------------ -</span>
        <span class="c1"># | 0 | 1 | 2 |     ==&gt;  | 0 | 1 | 2 | </span>
        <span class="c1"># +------------ -        +------------ -</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">progress</span><span class="p">:</span>
            <span class="c1"># First site will be trained more since it starts from a </span>
            <span class="c1"># random configuration of parameters</span>
            <span class="k">if</span> <span class="n">site</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">n_epochs</span>
                <span class="c1"># Random initial state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_params</span><span class="p">))</span> <span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epochs</span> <span class="o">=</span> <span class="n">n_epochs</span>
                <span class="c1"># Initial state is the final state of last site trained</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vqe_params0</span><span class="p">[</span><span class="n">pred_site</span><span class="p">])</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">train_site</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">site</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">true_e0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> 
            <span class="n">pred_site</span> <span class="o">=</span> <span class="n">site</span>  <span class="c1"># Previous site for next training</span></div>

<div class="viewcode-block" id="vqe.train_excited"><a class="viewcode-back" href="../../PhaseEstimation.html#PhaseEstimation.vqe.vqe.train_excited">[docs]</a>    <span class="k">def</span> <span class="nf">train_excited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lr</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">beta</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">circuit</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Training function through VQD.</span>
<span class="sd">        VQD is trained finding psi such that:</span>
<span class="sd">        &lt;psi|H|psi&gt; + beta*|&lt;psi_0|psi&gt;|**2</span>
<span class="sd">        is minimized.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lr : float</span>
<span class="sd">            Learning rate to be multiplied in the circuit-gradient output</span>
<span class="sd">        n_epochs : int</span>
<span class="sd">            Total number of epochs for each learning</span>
<span class="sd">        beta : float</span>
<span class="sd">            Importance (regularization strenght) given to the orthogonalization with psi_0</span>
<span class="sd">        circuit : bool</span>
<span class="sd">            if True -&gt; Prints the circuit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pred_site</span> <span class="p">:</span> <span class="nb">int</span>
        
        <span class="k">if</span> <span class="n">circuit</span><span class="p">:</span>
            <span class="c1"># Display the circuit</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;+--- CIRCUIT ---+&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Initialize parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vqe_e1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">n_states</span><span class="p">,)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">n_states</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_params</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">n_states</span><span class="p">,))</span>
        
        <span class="n">progress</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">recycle_rule</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">progress</span><span class="p">:</span>
            <span class="c1"># First site will be trained more since it starts from a </span>
            <span class="c1"># random configuration of parameters</span>
            <span class="k">if</span> <span class="n">site</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">n_epochs</span>
                <span class="c1"># Random initial state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params1</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_params</span><span class="p">))</span> <span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epochs</span> <span class="o">=</span> <span class="n">n_epochs</span>
                <span class="c1"># Initial state is the final state of last site trained</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params1</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vqe_params1</span><span class="p">[</span><span class="n">pred_site</span><span class="p">])</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">train_site_excited</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">site</span><span class="p">),</span> <span class="n">beta</span><span class="p">)</span>
            <span class="n">pred_site</span> <span class="o">=</span> <span class="n">site</span> <span class="c1"># Previous site for next training</span></div>

<div class="viewcode-block" id="vqe.train_refine"><a class="viewcode-back" href="../../PhaseEstimation.html#PhaseEstimation.vqe.vqe.train_refine">[docs]</a>    <span class="k">def</span> <span class="nf">train_refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lr</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">acc_thr</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">assist</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Training only the sites that have an accuracy score worse (higher) than acc_thr</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lr : float</span>
<span class="sd">            Learning rate to be multiplied in the circuit-gradient output</span>
<span class="sd">        n_epochs : int</span>
<span class="sd">            Total number of epochs for each learning</span>
<span class="sd">        acc_thr : float</span>
<span class="sd">            Accuracy threshold for which selecting the sites to train</span>
<span class="sd">        assist : bool</span>
<span class="sd">            if True -&gt; Each site that will be trained will start from the neighbouring site</span>
<span class="sd">            that has the better accuracy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">n_states</span><span class="p">),</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Select the sites to train based on their accuracy score</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">recycle_rule</span><span class="p">:</span>
            <span class="c1"># Accuracy value of the given site</span>
            <span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">vqe_e0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_e0</span><span class="p">[</span><span class="n">site</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">true_e0</span><span class="p">[</span><span class="n">site</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">accuracy</span> <span class="o">&gt;</span> <span class="n">acc_thr</span><span class="p">:</span> <span class="c1"># If the accuracy is bad (higher than threshold)...</span>
                <span class="c1"># if assist we copy the state from the best neighbouring site and</span>
                <span class="c1"># starting training from there</span>
                <span class="k">if</span> <span class="n">assist</span><span class="p">:</span>
                    <span class="c1"># Array of indexes of neighbouring sites</span>
                    <span class="n">neighbours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_neighbours</span><span class="p">(</span><span class="n">site</span><span class="p">))</span>
                    <span class="c1"># Array of their respective accuracies</span>
                    <span class="n">neighbours_accuracies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">vqe_e0</span><span class="p">[</span><span class="n">neighbours</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_e0</span><span class="p">[</span><span class="n">neighbours</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">true_e0</span><span class="p">[</span><span class="n">neighbours</span><span class="p">])</span>
                    <span class="c1"># Select the index of the neighbour with the best (lowest) accuracy score</span>
                    <span class="n">best_neighbour</span> <span class="o">=</span> <span class="n">neighbours</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">neighbours_accuracies</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vqe_params0</span><span class="p">[</span><span class="n">best_neighbour</span><span class="p">])</span>
                <span class="c1"># Start training the site</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_site</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">site</span><span class="p">)</span> <span class="p">)</span>

            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="vqe.train_refine_excited"><a class="viewcode-back" href="../../PhaseEstimation.html#PhaseEstimation.vqe.vqe.train_refine_excited">[docs]</a>    <span class="k">def</span> <span class="nf">train_refine_excited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lr</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">acc_thr</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">beta</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">assist</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Training only the sites that have an accuracy score worse (higher) than acc_thr</span>
<span class="sd">        for the excited states</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lr : float</span>
<span class="sd">            Learning rate to be multiplied in the circuit-gradient output</span>
<span class="sd">        n_epochs : int</span>
<span class="sd">            Total number of epochs for each learning</span>
<span class="sd">        acc_thr : float</span>
<span class="sd">            Accuracy threshold for which selecting the sites to train</span>
<span class="sd">        assist : bool</span>
<span class="sd">            if True -&gt; Each site that will be trained will start from the neighbouring site</span>
<span class="sd">            that has the better accuracy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">n_states</span><span class="p">),</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Select the sites to train based on their accuracy score</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">recycle_rule</span><span class="p">:</span>
            <span class="c1"># Accuracy value of the given site</span>
            <span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">vqe_e1</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_e1</span><span class="p">[</span><span class="n">site</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">true_e1</span><span class="p">[</span><span class="n">site</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">accuracy</span> <span class="o">&gt;</span> <span class="n">acc_thr</span><span class="p">:</span> <span class="c1"># If the accuracy is bad (higher than threshold)...</span>
                <span class="c1"># if assist we copy the state from the best neighbouring site and</span>
                <span class="c1"># starting training from there</span>
                <span class="k">if</span> <span class="n">assist</span><span class="p">:</span>
                    <span class="c1"># Array of indexes of neighbouring sites</span>
                    <span class="n">neighbours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_neighbours</span><span class="p">(</span><span class="n">site</span><span class="p">))</span>
                    <span class="c1"># Array of their respective accuracies</span>
                    <span class="n">neighbours_accuracies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">vqe_e1</span><span class="p">[</span><span class="n">neighbours</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_e1</span><span class="p">[</span><span class="n">neighbours</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">true_e1</span><span class="p">[</span><span class="n">neighbours</span><span class="p">])</span>
                    <span class="c1"># Select the index of the neighbour with the best (lowest) accuracy score</span>
                    <span class="n">best_neighbour</span> <span class="o">=</span> <span class="n">neighbours</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">neighbours_accuracies</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params1</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vqe_params1</span><span class="p">[</span><span class="n">best_neighbour</span><span class="p">])</span>
                <span class="c1"># Start training the site</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_site_excited</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">site</span><span class="p">),</span> <span class="n">beta</span><span class="p">)</span>

            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="vqe.save"><a class="viewcode-back" href="../../PhaseEstimation.html#PhaseEstimation.vqe.vqe.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save main parameters of the VQE class to a local file.</span>
<span class="sd">        Parameters saved:</span>
<span class="sd">        &gt; Hs class, vqe parameters, circuit function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Local file to save the parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid name for file&#39;</span><span class="p">)</span>

        <span class="c1"># Check if the VQE was trained for excited states aswell:</span>
        <span class="n">excited</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">excited</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">excited</span><span class="p">:</span>
            <span class="n">things_to_save</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vqe_e0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">true_e0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">circuit_fun</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">things_to_save</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vqe_e0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">true_e0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vqe_params1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vqe_e1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">true_e1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">circuit_fun</span>
            <span class="p">]</span>
            
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">things_to_save</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="load_vqe"><a class="viewcode-back" href="../../PhaseEstimation.html#PhaseEstimation.vqe.load_vqe">[docs]</a><span class="k">def</span> <span class="nf">load_vqe</span><span class="p">(</span><span class="n">filename</span> <span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">vqe</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load main parameters of a VQE class saved to a local file using vqe.save(filename)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Local file from where to load the parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    class</span>
<span class="sd">        VQE class with main parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid name for file&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">things_to_load</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">things_to_load</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">Hs</span><span class="p">,</span> <span class="n">vqe_params</span><span class="p">,</span> <span class="n">vqe_e</span><span class="p">,</span> <span class="n">true_e</span><span class="p">,</span> <span class="n">circuit_fun</span> <span class="o">=</span> <span class="n">things_to_load</span>
        <span class="n">loaded_vqe</span> <span class="o">=</span> <span class="n">vqe</span><span class="p">(</span><span class="n">Hs</span><span class="p">,</span> <span class="n">circuit_fun</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Hs</span><span class="p">,</span> <span class="n">vqe_params</span><span class="p">,</span> <span class="n">vqe_e</span><span class="p">,</span> <span class="n">true_e</span><span class="p">,</span> <span class="n">vqe_params1</span><span class="p">,</span> <span class="n">vqe_e1</span><span class="p">,</span> <span class="n">true_e1</span><span class="p">,</span> <span class="n">circuit_fun</span> <span class="o">=</span> <span class="n">things_to_load</span>
        <span class="n">loaded_vqe</span> <span class="o">=</span> <span class="n">vqe</span><span class="p">(</span><span class="n">Hs</span><span class="p">,</span> <span class="n">circuit_fun</span><span class="p">)</span>
        <span class="n">loaded_vqe</span><span class="o">.</span><span class="n">vqe_params1</span> <span class="o">=</span> <span class="n">vqe_params1</span>
        <span class="n">loaded_vqe</span><span class="o">.</span><span class="n">vqe_e1</span> <span class="o">=</span> <span class="n">vqe_e1</span>
        <span class="n">loaded_vqe</span><span class="o">.</span><span class="n">true_e1</span> <span class="o">=</span> <span class="n">true_e1</span>
    
    <span class="n">loaded_vqe</span><span class="o">.</span><span class="n">vqe_params0</span> <span class="o">=</span> <span class="n">vqe_params</span>
    <span class="n">loaded_vqe</span><span class="o">.</span><span class="n">vqe_e0</span> <span class="o">=</span> <span class="n">vqe_e</span>
    <span class="n">loaded_vqe</span><span class="o">.</span><span class="n">true_e0</span> <span class="o">=</span> <span class="n">true_e</span>
    
    <span class="k">return</span> <span class="n">loaded_vqe</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Saverio Monaco.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>